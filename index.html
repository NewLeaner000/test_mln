<script>
    // --- C·∫§U H√åNH ---
    // PASTE LINK NGROK C·ª¶A B·∫†N V√ÄO ƒê√ÇY (V√≠ d·ª•: https://a1b2.ngrok-free.app)
    const API_URL = "https://nonvicarious-yuonne-lageniform.ngrok-free.dev";
    
    const staticEvents = [
        {
            text: "M·ªôt nh√† th·∫ßu ƒë·ªÅ ngh·ªã 'l·∫°i qu·∫£' 20% gi√° tr·ªã h·ª£p ƒë·ªìng.",
            options: [
                { text: "ƒê·ªìng √Ω (Tham √¥)", trust: -30, budget: 20, msg: "B·∫°n c√≥ ti·ªÅn, nh∆∞ng l∆∞∆°ng t√¢m c·∫Øn r·ª©t." },
                { text: "T·ª´ ch·ªëi", trust: 10, budget: 0, msg: "B·∫°n gi·ªØ ƒë∆∞·ª£c ph·∫©m gi√°." }
            ]
        },
        {
            text: "C·∫ßn mua thi·∫øt b·ªã m·ªõi. H√†ng ngo·∫°i nh·∫≠p hay h√†ng n·ªôi ƒë·ªãa?",
            options: [
                { text: "H√†ng ngo·∫°i ƒë·∫Øt ƒë·ªè (L√£ng ph√≠)", trust: 0, budget: -30, msg: "Ng√¢n s√°ch th√¢m h·ª•t n·∫∑ng." },
                { text: "H√†ng n·ªôi ƒë·ªãa (Ti·∫øt ki·ªám)", trust: 5, budget: -10, msg: "Ti·∫øt ki·ªám ng√¢n s√°ch hi·ªáu qu·∫£." }
            ]
        }
    ];

    let state = { day: 1, trust: 100, budget: 100, alive: true, history: [] };

    function startGame() {
        state = { day: 1, trust: 100, budget: 100, alive: true, history: [] };
        updateUI();
        document.getElementById('log').innerHTML = "";
        nextTurn();
    }

    async function nextTurn() {
        if (!state.alive) return;
        
        if (state.day > 30) {
            endGame("WIN");
            return;
        }

        // KI·ªÇM TRA S·ª∞ KI·ªÜN MINIBOSS (Ng√†y 10, 20, 30)
        if (state.day === 10 || state.day === 20 || state.day === 30) {
            document.getElementById('story-text').innerText = "‚ö†Ô∏è ƒêANG K·∫æT N·ªêI V·ªöI TRUNG ∆Ø∆†NG (AI GENERATING)...";
            document.getElementById('choices').innerHTML = ""; // ·∫®n n√∫t khi ƒëang load
            
            try {
                // G·ªçi v·ªÅ Laptop c·ªßa b·∫°n ƒë·ªÉ l·∫•y t√¨nh hu·ªëng
                const response = await fetch(`${API_URL}/generate-boss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        day: state.day,
                        trust: state.trust,
                        budget: state.budget,
                        history: state.history
                    })
                });
                
                const bossEvent = await response.json();
                renderEvent(bossEvent, true); // true = Boss Mode
            } catch (error) {
                console.error(error);
                renderEvent({ text: "M·∫•t k·∫øt n·ªëi v·ªõi c·∫•p tr√™n! (L·ªói Server)", options: [{text: "B·ªè qua", trust: 0, budget: 0, msg: "May m·∫Øn tho√°t n·∫°n."}] });
            }
        } else {
            // Ng√†y th∆∞·ªùng: L·∫•y random c√≥ s·∫µn cho nhanh
            const randomEvent = staticEvents[Math.floor(Math.random() * staticEvents.length)];
            renderEvent(randomEvent, false);
        }
    }

    function renderEvent(eventData, isBoss) {
        let prefix = isBoss ? "üî¥ [B√ÅO ƒê·ªòNG ƒê·ªé] " : "";
        document.getElementById('story-text').innerText = `NG√ÄY ${state.day}: ${prefix}${eventData.text}`;
        const choiceDiv = document.getElementById('choices');
        choiceDiv.innerHTML = ""; 

        eventData.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.innerText = opt.text;
            // L∆∞u text l·ª±a ch·ªçn ƒë·ªÉ g·ª≠i cho AI l·∫ßn sau
            btn.onclick = () => handleChoice(opt, opt.text);
            if (isBoss) btn.style.border = "1px solid red"; // N√∫t boss m√†u ƒë·ªè
            choiceDiv.appendChild(btn);
        });
    }

    function handleChoice(option, choiceText) {
        state.trust += (option.trust || 0);
        state.budget += (option.budget || 0);
        
        // Ghi log h√†nh ƒë·ªông ƒë·ªÉ AI h·ªçc
        state.history.push(choiceText);

        if (state.trust > 100) state.trust = 100;
        if (state.budget > 100) state.budget = 100;

        const log = document.getElementById('log');
        log.innerHTML = `> Ng√†y ${state.day}: ${option.msg}<br>` + log.innerHTML;

        checkStatus();
        
        if (state.alive) {
            state.day++;
            updateUI();
            setTimeout(nextTurn, 1000); 
        }
    }

    // ... (Gi·ªØ nguy√™n c√°c h√†m checkStatus, endGame, updateUI c≈©) ...
    function checkStatus() {
        if (state.trust <= 0) endGame("LOSE_TRUST");
        else if (state.budget <= 0) endGame("LOSE_MONEY");
    }
    
    function endGame(type) {
        state.alive = false;
        let msg = "", color = "red";
        if (type === "WIN") { msg = "CH√öC M·ª™NG! B·∫°n ƒë√£ chi·∫øn th·∫Øng!"; color = "#00ff00"; }
        else if (type === "LOSE_TRUST") { msg = "GAME OVER: M·∫•t h·∫øt uy t√≠n."; }
        else if (type === "LOSE_MONEY") { msg = "GAME OVER: Ng√¢n s√°ch c·∫°n ki·ªát."; }
        
        document.getElementById('story-text').innerHTML = `<h2 style="color:${color}">${msg}</h2>`;
        document.getElementById('choices').innerHTML = '<button onclick="startGame()">Ch∆°i l·∫°i</button>';
    }

    function updateUI() {
        document.getElementById('day').innerText = state.day;
        document.getElementById('trust').innerText = state.trust;
        document.getElementById('budget').innerText = state.budget;
        document.getElementById('trust').className = state.trust < 30 ? "red" : "";
        document.getElementById('budget').className = state.budget < 30 ? "red" : "";
    }
</script>